name: UAV Assessment CI

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  DOCKER_IMAGE: uav-assessment-env:ci   # tek noktadan değiştir

jobs:
  sim-tests:
    runs-on: ubuntu-latest

    steps:
    # 1) Kodu al
    - name: Checkout repo
      uses: actions/checkout@v4

    # 2) Buildx + cache
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # 3) Docker imajını build et
    - name: Build container
      uses: docker/build-push-action@v5
      with:
        context: .
        load: true
        tags: ${{ env.DOCKER_IMAGE }}
        cache-from: type=gha
        cache-to:   type=gha,mode=max

    # ---------- TASK 1 ----------
    - name: 🚀 Run Task 1 – Arm / Disarm
      id: task1                          # <--- BENZERSİZ
      run: |
        docker run --rm -t $DOCKER_IMAGE bash -c '
          set -e
          cd /ros2_ws
          colcon build --symlink-install
          colcon test --packages-select test_package \
                      --event-handlers console_direct+ \
                      --pytest-args "--launch-testing -s -v"
          colcon test-result --verbose
        '

    # ---------- TASK 2 ----------
    - name: 🚀 Run Task 2 – Take-off / Land
      id: task2                          # <--- YENİ id
      run: |
        docker run --rm -t $DOCKER_IMAGE bash -c '
          set -e
          cd /ros2_ws
          colcon build --symlink-install
          colcon test --packages-select test_package \
                      --event-handlers console_direct+ \
                      --pytest-args "--launch-testing -s -v"
          colcon test-result --verbose
        '

    # ---------- ÖZET ----------
    - name: 📊 Generate summary
      if: always()
      run: |
        echo "## 📝 UAV Assessment Sonucu" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [[ "${{ steps.task1.outcome }}" == "success" ]]; then
          echo "### ✅ Task 1 (Arm/Disarm) PASS" >> $GITHUB_STEP_SUMMARY
        else
          echo "### ❌ Task 1 (Arm/Disarm) FAIL" >> $GITHUB_STEP_SUMMARY
        fi

        if [[ "${{ steps.task2.outcome }}" == "success" ]]; then
          echo "### ✅ Task 2 (Take-off/Land) PASS" >> $GITHUB_STEP_SUMMARY
        else
          echo "### ❌ Task 2 (Take-off/Land) FAIL" >> $GITHUB_STEP_SUMMARY
        fi
