name: UAV Assessment CI

# Bu iÅŸ akÄ±ÅŸÄ± ne zaman tetiklenecek?
# - main branch'ine bir push yapÄ±ldÄ±ÄŸÄ±nda
# - Manuel olarak "Run workflow" butonuna tÄ±klandÄ±ÄŸÄ±nda
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # 'test' adÄ±nda tek bir iÅŸimiz var
  test:
    # En gÃ¼ncel Ubuntu sunucusunda Ã§alÄ±ÅŸacak
    runs-on: ubuntu-latest
    name: Run Simulation Tests

    steps:
      # 1. AdÄ±m: AdayÄ±n kodunu sunucuya indirir
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. AdÄ±m: Docker'Ä± kurar ve hazÄ±rlar
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. AdÄ±m: Docker imajÄ±nÄ± oluÅŸturur (daha Ã¶nce saatlerce uÄŸraÅŸtÄ±ÄŸÄ±mÄ±z Dockerfile'Ä± kullanarak)
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          tags: uav-assessment-env:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # --- Testleri AyrÄ± AyrÄ± Ã‡alÄ±ÅŸtÄ±rma ---
      # Her gÃ¶rev iÃ§in testi ayrÄ± bir adÄ±mda Ã§alÄ±ÅŸtÄ±rÄ±yoruz ki sonuÃ§larÄ± ayrÄ± raporlayabilelim.
      
      - name: Run Task 1 Test - Arm/Disarm
        id: task1
        continue-on-error: true # Bu adÄ±m baÅŸarÄ±sÄ±z olsa bile iÅŸ akÄ±ÅŸÄ± durmasÄ±n
        run: |
          docker run --rm -t uav-assessment-env bash -c "source /root/ros2_ws/install/setup.bash && colcon test --packages-select test_package --ctest-args '-R test_task_1_arm_disarm'"

      # Buraya GÃ¶rev 2 (KalkÄ±ÅŸ/Ä°niÅŸ) iÃ§in testler eklenebilir.
      # Ã–nce 'test_task_2_takeoff_land.py' adÄ±nda bir test dosyasÄ± oluÅŸturmanÄ±z gerekir.
      # - name: Run Task 2 Test - Takeoff/Land
      #   id: task2
      #   continue-on-error: true
      #   run: |
      #     docker run --rm -t uav-assessment-env bash -c "source /root/ros2_ws/install/setup.bash && colcon test --packages-select test_package --ctest-args '-R test_task_2_takeoff_land'"

      # 4. AdÄ±m: DeÄŸerlendirme Raporunu OluÅŸturma (âœ…/âŒ KÄ±smÄ±)
      - name: Generate Assessment Report
        if: always() # Bu adÄ±m, testler baÅŸarÄ±sÄ±z olsa bile her zaman Ã§alÄ±ÅŸÄ±r
        run: |
          echo "## ðŸ“ Aday DeÄŸerlendirme Raporu" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ steps.task1.outcome }}" == "success" ]]; then
            echo "### âœ… GÃ¶rev 1: Arm ve Disarm BaÅŸarÄ±lÄ±" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ GÃ¶rev 1: Arm ve Disarm BaÅŸarÄ±sÄ±z" >> $GITHUB_STEP_SUMMARY
            echo "**Detaylar:** 'Run Task 1 Test' adÄ±mÄ±nÄ±n loglarÄ±nÄ± inceleyin." >> $GITHUB_STEP_SUMMARY
          fi

          # GÃ¶rev 2 aktif edildiÄŸinde bu kÄ±sÄ±m da aÃ§Ä±lmalÄ±
          # if [[ "${{ steps.task2.outcome }}" == "success" ]]; then
          #   echo "### âœ… GÃ¶rev 2: Otonom KalkÄ±ÅŸ ve Ä°niÅŸ BaÅŸarÄ±lÄ±" >> $GITHUB_STEP_SUMMARY
          # else
          #   echo "### âŒ GÃ¶rev 2: Otonom KalkÄ±ÅŸ ve Ä°niÅŸ BaÅŸarÄ±sÄ±z" >> $GITHUB_STEP_SUMMARY
          #   echo "**Detaylar:** 'Run Task 2 Test' adÄ±mÄ±nÄ±n loglarÄ±nÄ± inceleyin." >> $GITHUB_STEP_SUMMARY
          # fi
