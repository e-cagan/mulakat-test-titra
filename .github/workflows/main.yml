name: UAV Assessment CI

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

env:
  # Docker imajÄ±nÄ±n tek kaynaÄŸÄ±
  DOCKER_IMAGE: uav-assessment-env:ci

jobs:
  sim-tests:
    runs-on: ubuntu-latest

    steps:
    # Kod
    - name: ğŸ“¥ Checkout repo
      uses: actions/checkout@v4

    # Docker builder + cache
    - name: ğŸ› ï¸  Set up Buildx
      uses: docker/setup-buildx-action@v3

    # Ä°majÄ± derle
    - name: ğŸ³ Build container
      uses: docker/build-push-action@v5
      with:
        context: .
        load: true
        tags: ${{ env.DOCKER_IMAGE }}
        cache-from: type=gha
        cache-to:   type=gha,mode=max

    # ---------- TASK 1 ----------
    - name: ğŸš€ Run Task 1 â€“ Arm / Disarm
      id: task1
      run: |
        docker run --rm -t $DOCKER_IMAGE bash -eo pipefail <<'INNER'
        cd /ros2_ws
        colcon build --symlink-install
        colcon test --packages-select test_package \
                     --event-handlers console_direct+ \
                     --pytest-args "--launch-testing" \
                     --pytest-args -s \
                     --pytest-args -v
        colcon test-result --verbose
INNER

    # ---------- TASK 2 ----------
    - name: ğŸš€ Run Task 2 â€“ Take-off / Land
      id: task2
      run: |
        docker run --rm -t $DOCKER_IMAGE bash -eo pipefail <<'INNER'
        cd /ros2_ws
        colcon build --symlink-install
        colcon test --packages-select test_package \
                     --event-handlers console_direct+ \
                     --pytest-args "--launch-testing" \
                     --pytest-args -s \
                     --pytest-args -v
        colcon test-result --verbose
INNER

    # ---------- Ã–zet ----------
    - name: ğŸ“Š Generate summary
      if: always()
      run: |
        {
          echo "## ğŸ“ UAV Assessment Raporu"
          echo
          if [[ '${{ steps.task1.outcome }}' == 'success' ]]; then
            echo "### âœ… Task 1 (Arm/Disarm) PASS"
          else
            echo "### âŒ Task 1 (Arm/Disarm) FAIL"
          fi
          if [[ '${{ steps.task2.outcome }}' == 'success' ]]; then
            echo "### âœ… Task 2 (Take-off/Land) PASS"
          else
            echo "### âŒ Task 2 (Take-off/Land) FAIL"
          fi
        } >> "$GITHUB_STEP_SUMMARY"
